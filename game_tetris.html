<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>俄罗斯方块</title>
<style>
    canvas {
        border: 1px solid black;
        display: block;
        margin: 0 auto;
    }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="800"></canvas>
<div id="score" style="text-align: center;">score: 0</div>
<div id="highScore" style="text-align: center;">hign score: 0</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const blockSize = 20;
const numRows = 40;
const numCols = 20;
const colors = ["#000000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#00FFFF", "#FF00FF", "#C0C0C0"];

let score = 0;
let highScore = localStorage.getItem("highScore") || 0;
document.getElementById("highScore").textContent = "high score: " + highScore;
let board = [];
for (let row = 0; row < numRows; row++) {
    board[row] = [];
    for (let col = 0; col < numCols; col++) {
        board[row][col] = 0;
    }
}

function drawSquare(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * blockSize, y * blockSize, blockSize, blockSize);
    ctx.strokeStyle = "#000000";
    ctx.strokeRect(x * blockSize, y * blockSize, blockSize, blockSize);
}

function drawBoard() {
    for (let row = 0; row < numRows; row++) {
        for (let col = 0; col < numCols; col++) {
            drawSquare(col, row, colors[board[row][col]]);
        }
    }
}

let currentPiece = {
    shape: [[1, 1], [1, 1]],
    color: 1,
    x: 4,
    y: 0
};

function drawPiece() {
    currentPiece.shape.forEach((row, i) => {
        row.forEach((value, j) => {
            if (value > 0) {
                drawSquare(currentPiece.x + j, currentPiece.y + i, colors[currentPiece.color]);
            }
        });
    });
}

function movePieceDown() {
    if (isValidMove(0, 1)) {
        currentPiece.y++;
    } else {
        placePiece();
        clearLines();
        currentPiece = generateRandomPiece();
        if (!isValidMove(0, 0)) {
            alert("游戏结束！");
            clearInterval(gameInterval);
        }
    }
}

function isValidMove(dx, dy) {
    for (let i = 0; i < currentPiece.shape.length; i++) {
        for (let j = 0; j < currentPiece.shape[i].length; j++) {
            if (currentPiece.shape[i][j]) {
                let newX = currentPiece.x + j + dx;
                let newY = currentPiece.y + i + dy;
                if (newX < 0 || newX >= numCols || newY >= numRows || board[newY][newX]) {
                    return false;
                }
            }
        }
    }
    return true;
}

function placePiece() {
    currentPiece.shape.forEach((row, i) => {
        row.forEach((value, j) => {
            if (value > 0) {
                board[currentPiece.y + i][currentPiece.x + j] = currentPiece.color;
            }
        });
    });
}

function clearLines() {
    for (let row = numRows - 1; row >= 0; row--) {
        if (board[row].every(cell => cell !== 0)) {
            board.splice(row, 1);
            board.unshift(Array(numCols).fill(0));

            score++;
            document.getElementById("score").textContent = "score: " + score; // 更新得分显示

            if (score > highScore) {
                highScore = score;
                localStorage.setItem("highScore", highScore);
                document.getElementById("highScore").textContent = "high score: " + highScore; // 更新历史最高得分显示
            }
        }
    }
}

function rotatePiece() {
    const rotatedPiece = [];
    for (let col = 0; col < currentPiece.shape[0].length; col++) {
        rotatedPiece[col] = [];
        for (let row = 0; row < currentPiece.shape.length; row++) {
            rotatedPiece[col][row] = currentPiece.shape[currentPiece.shape.length - 1 - row][col];
        }
    }
    if (isValidRotation(rotatedPiece)) {
        currentPiece.shape = rotatedPiece;
    }
}

function isValidRotation(rotatedPiece) {
    for (let i = 0; i < rotatedPiece.length; i++) {
        for (let j = 0; j < rotatedPiece[i].length; j++) {
            if (rotatedPiece[i][j] && (currentPiece.x + j < 0 || currentPiece.x + j >= numCols || currentPiece.y + i >= numRows || board[currentPiece.y + i][currentPiece.x + j])) {
                return false;
            }
        }
    }
    return true;
}

function generateRandomPiece() {
    const shapes = [
        [[1, 1], [1, 1]], // Square
        [[1, 1, 1, 1]],    // Line
        [[1, 1, 0], [0, 1, 1]], // S
        [[0, 1, 1], [1, 1, 0]], // Z
        [[1, 1, 1], [0, 1, 0]], // T
        [[1, 1, 1, 1]],    // Line
        [[1, 1, 1], [1, 0, 0]] // L
    ];
    const colors = [1, 2, 3, 4, 5, 6, 7];
    const shape = shapes[Math.floor(Math.random() * shapes.length)];
    const color = colors[Math.floor(Math.random() * colors.length)];
    return {
        shape: shape,
        color: color,
        x: Math.floor(numCols / 2) - Math.floor(shape[0].length / 2),
        y: 0
    };
}

document.addEventListener("keydown", event => {
    switch (event.keyCode) {
        case 37: // 左箭头
            if (isValidMove(-1, 0)) {
                currentPiece.x--;
            }
            break;
        case 39: // 右箭头
            if (isValidMove(1, 0)) {
                currentPiece.x++;
            }
            break;
        case 40: // 下箭头
            movePieceDown();
            break;
        case 38: // 上箭头
            rotatePiece();
            break;
    }
});

function gameLoop() {
    movePieceDown();
    drawBoard();
    drawPiece();
}

setInterval(gameLoop, 200);
</script>
</body>
</html>
